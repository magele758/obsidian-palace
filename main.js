var D=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var H=(p,e)=>{for(var t in e)D(p,t,{get:e[t],enumerable:!0})},z=(p,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of R(e))!K.call(p,n)&&n!==t&&D(p,n,{get:()=>e[n],enumerable:!(a=U(e,n))||a.enumerable});return p};var q=p=>z(D({},"__esModule",{value:!0}),p);var Y={};H(Y,{default:()=>b});module.exports=q(Y);var o=require("obsidian");var m=require("obsidian"),N={baseUrl:"https://api.openai.com/v1",apiKey:"",modelName:"gpt-4o",targetLang:"\u7B80\u4F53\u4E2D\u6587",systemPrompt:"",maxChunkSize:3e3,translationMode:"newFile"},C=class extends m.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"AI Translator \u8BBE\u7F6E"}),new m.Setting(e).setName("API Base URL").setDesc("OpenAI \u517C\u5BB9 API \u7684\u57FA\u7840\u5730\u5740\uFF08\u5982 https://api.openai.com/v1\uFF09").addText(t=>t.setPlaceholder("https://api.openai.com/v1").setValue(this.plugin.settings.baseUrl).onChange(async a=>{this.plugin.settings.baseUrl=a,await this.plugin.saveSettings()})),new m.Setting(e).setName("API Key").setDesc("API \u5BC6\u94A5").addText(t=>{t.setPlaceholder("sk-...").setValue(this.plugin.settings.apiKey).onChange(async a=>{this.plugin.settings.apiKey=a,await this.plugin.saveSettings()}),t.inputEl.type="password"}),new m.Setting(e).setName("\u6A21\u578B\u540D\u79F0").setDesc("\u4F7F\u7528\u7684\u6A21\u578B\u540D\u79F0\uFF08\u5982 gpt-4o, deepseek-chat \u7B49\uFF09").addText(t=>t.setPlaceholder("gpt-4o").setValue(this.plugin.settings.modelName).onChange(async a=>{this.plugin.settings.modelName=a,await this.plugin.saveSettings()})),new m.Setting(e).setName("\u76EE\u6807\u8BED\u8A00").setDesc("\u7FFB\u8BD1\u7684\u76EE\u6807\u8BED\u8A00").addText(t=>t.setPlaceholder("\u7B80\u4F53\u4E2D\u6587").setValue(this.plugin.settings.targetLang).onChange(async a=>{this.plugin.settings.targetLang=a,await this.plugin.saveSettings()})),new m.Setting(e).setName("\u7FFB\u8BD1\u6A21\u5F0F").setDesc("\u9009\u62E9\u7FFB\u8BD1\u7ED3\u679C\u7684\u8F93\u51FA\u65B9\u5F0F").addDropdown(t=>t.addOption("newFile","\u751F\u6210\u65B0\u6587\u4EF6").addOption("append","\u8FFD\u52A0\u5230\u539F\u6587\u4E0B\u65B9").addOption("replace","\u66FF\u6362\u539F\u6587").setValue(this.plugin.settings.translationMode).onChange(async a=>{this.plugin.settings.translationMode=a,await this.plugin.saveSettings()})),new m.Setting(e).setName("\u81EA\u5B9A\u4E49\u7CFB\u7EDF\u63D0\u793A\u8BCD").setDesc("\u7559\u7A7A\u4F7F\u7528\u9ED8\u8BA4\u63D0\u793A\u8BCD\u3002\u53EF\u7528 {targetLang} \u4F5C\u4E3A\u76EE\u6807\u8BED\u8A00\u5360\u4F4D\u7B26\u3002").addTextArea(t=>{t.setPlaceholder("\u7559\u7A7A\u4F7F\u7528\u9ED8\u8BA4\u63D0\u793A\u8BCD...").setValue(this.plugin.settings.systemPrompt).onChange(async a=>{this.plugin.settings.systemPrompt=a,await this.plugin.saveSettings()}),t.inputEl.rows=6,t.inputEl.cols=50}),new m.Setting(e).setName("\u5355\u6B21\u7FFB\u8BD1\u6700\u5927\u5B57\u7B26\u6570").setDesc("\u957F\u6587\u6863\u4F1A\u6309\u6B64\u5927\u5C0F\u5206\u5757\u7FFB\u8BD1\uFF0C\u5EFA\u8BAE 2000-5000").addText(t=>t.setPlaceholder("3000").setValue(String(this.plugin.settings.maxChunkSize)).onChange(async a=>{let n=parseInt(a,10);!isNaN(n)&&n>0&&(this.plugin.settings.maxChunkSize=n,await this.plugin.saveSettings())}))}};var $=require("obsidian"),_=`You are a professional translator. Translate the following content to {targetLang}.

Rules:
1. Preserve all Markdown formatting, including headings, lists, links, images, code blocks, and inline code.
2. Do not translate content inside code blocks (\`\`\` or \`).
3. Do not translate URLs, file paths, or variable names.
4. Keep the original paragraph structure.
5. Only output the translated content, do not add explanations or notes.`,v=class{constructor(e){this.config=e}splitIntoChunks(e){let{maxChunkSize:t}=this.config;if(e.length<=t)return[e];let a=[],n=e.split(/\n\n+/),s="";for(let i of n){if(i.length>t){s.trim()&&(a.push(s.trim()),s="");let h=i.split(`
`);for(let c of h)(s+`
`+c).length>t&&s.trim()?(a.push(s.trim()),s=c):s=s?s+`
`+c:c;continue}let r=s?s+`

`+i:i;r.length>t&&s.trim()?(a.push(s.trim()),s=i):s=r}return s.trim()&&a.push(s.trim()),a}async translateChunk(e){let{baseUrl:t,apiKey:a,modelName:n,targetLang:s,systemPrompt:i}=this.config,h=[{role:"system",content:(i||_).replace(/\{targetLang\}/g,s)},{role:"user",content:e}],c=t.replace(/\/+$/,"")+"/chat/completions",u=await(0,$.requestUrl)({url:c,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({model:n,messages:h,temperature:.3})});if(u.status!==200)throw new Error(`API \u8BF7\u6C42\u5931\u8D25 (${u.status}): ${u.text}`);let d=u.json;if(!d.choices||d.choices.length===0)throw new Error("API \u8FD4\u56DE\u4E86\u7A7A\u7684\u54CD\u5E94");return d.choices[0].message.content}async translateDocument(e,t){let a=this.splitIntoChunks(e),n=[];for(let s=0;s<a.length;s++){t&&t(s+1,a.length);try{let i=await this.translateChunk(a[s]);n.push(i)}catch(i){let r=i instanceof Error?i.message:String(i);throw new Error(`\u7FFB\u8BD1\u7B2C ${s+1}/${a.length} \u6BB5\u65F6\u51FA\u9519: ${r}`)}}return n.join(`

`)}};var l=require("obsidian"),w="ai-chat-view",W=[{label:"\u{1F4DD} \u603B\u7ED3",prompt:"\u8BF7\u7528\u7B80\u6D01\u7684\u4E2D\u6587\u603B\u7ED3\u8FD9\u7BC7\u6587\u6863\u7684\u6838\u5FC3\u5185\u5BB9\uFF0C\u5206\u8981\u70B9\u5217\u51FA\u3002"},{label:"\u{1F511} \u5173\u952E\u6982\u5FF5",prompt:"\u8BF7\u63D0\u53D6\u8FD9\u7BC7\u6587\u6863\u4E2D\u7684\u5173\u952E\u6982\u5FF5\u548C\u672F\u8BED\uFF0C\u5E76\u9010\u4E00\u7B80\u8981\u89E3\u91CA\u3002"},{label:"\u2753 \u751F\u6210\u95EE\u7B54",prompt:"\u57FA\u4E8E\u8FD9\u7BC7\u6587\u6863\u7684\u5185\u5BB9\uFF0C\u751F\u62105\u4E2A\u6709\u6DF1\u5EA6\u7684\u95EE\u7B54\u5BF9\uFF0C\u5E2E\u52A9\u7406\u89E3\u6587\u6863\u3002"},{label:"\u{1F50D} \u6DF1\u5EA6\u5206\u6790",prompt:"\u8BF7\u5BF9\u8FD9\u7BC7\u6587\u6863\u8FDB\u884C\u6DF1\u5EA6\u5206\u6790\uFF0C\u5305\u62EC\uFF1A\u4E3B\u9898\u3001\u8BBA\u70B9\u3001\u903B\u8F91\u7ED3\u6784\u3001\u6F5C\u5728\u7684\u4E0D\u8DB3\u6216\u53EF\u6539\u8FDB\u4E4B\u5904\u3002"},{label:"\u270F\uFE0F \u6539\u5199\u4F18\u5316",prompt:"\u8BF7\u6307\u51FA\u8FD9\u7BC7\u6587\u6863\u5728\u8868\u8FBE\u3001\u7ED3\u6784\u3001\u903B\u8F91\u4E0A\u53EF\u4EE5\u4F18\u5316\u7684\u5730\u65B9\uFF0C\u5E76\u7ED9\u51FA\u5177\u4F53\u5EFA\u8BAE\u3002"}],j=`\u4F60\u662F\u4E00\u4E2A\u5D4C\u5165\u5728 Obsidian \u7B14\u8BB0\u8F6F\u4EF6\u4E2D\u7684 AI \u52A9\u624B\u3002\u7528\u6237\u4F1A\u7ED9\u4F60\u4E00\u7BC7\u6587\u6863\u7684\u5185\u5BB9\uFF0C\u4F60\u9700\u8981\u57FA\u4E8E\u6587\u6863\u5185\u5BB9\u56DE\u7B54\u7528\u6237\u7684\u95EE\u9898\u3002

\u89C4\u5219\uFF1A
1. \u56DE\u7B54\u5E94\u57FA\u4E8E\u6587\u6863\u5185\u5BB9\uFF0C\u5FC5\u8981\u65F6\u53EF\u7ED3\u5408\u4F60\u7684\u77E5\u8BC6\u8865\u5145\u3002
2. \u4F7F\u7528 Markdown \u683C\u5F0F\u56DE\u7B54\u3002
3. \u56DE\u7B54\u5E94\u7B80\u6D01\u3001\u51C6\u786E\u3001\u6709\u6761\u7406\u3002
4. \u5982\u679C\u6587\u6863\u5185\u5BB9\u4E0D\u8DB3\u4EE5\u56DE\u7B54\u95EE\u9898\uFF0C\u8BF7\u660E\u786E\u8BF4\u660E\u3002`,y=class extends l.ItemView{constructor(t,a){super(t);this.messages=[];this.isLoading=!1;this.currentDocContent=null;this.currentDocName=null;this.abortController=null;this.plugin=a}getViewType(){return w}getDisplayText(){return"AI \u52A9\u624B"}getIcon(){return"message-square"}async onOpen(){let t=this.containerEl.children[1];t.empty(),t.addClass("ai-chat-container");let a=t.createDiv({cls:"ai-chat-header"}),n=a.createDiv({cls:"ai-chat-header-title"}),s=n.createSpan({cls:"ai-chat-header-icon"});(0,l.setIcon)(s,"bot"),n.createSpan({text:"AI \u6587\u6863\u52A9\u624B"});let r=a.createDiv({cls:"ai-chat-header-actions"}).createEl("button",{cls:"ai-chat-icon-btn",attr:{"aria-label":"\u6E05\u7A7A\u5BF9\u8BDD"}});(0,l.setIcon)(r,"trash-2"),r.addEventListener("click",()=>this.clearChat()),this.docInfoEl=t.createDiv({cls:"ai-chat-doc-info"}),this.updateDocInfo(),this.messagesContainer=t.createDiv({cls:"ai-chat-messages"}),this.renderWelcome();let h=t.createDiv({cls:"ai-chat-quick-actions"});for(let f of W)h.createEl("button",{cls:"ai-chat-quick-btn",text:f.label}).addEventListener("click",()=>{this.isLoading||(this.inputEl.value=f.prompt,this.sendCurrentMessage())});let c=t.createDiv({cls:"ai-chat-input-area"});this.inputEl=c.createEl("textarea",{cls:"ai-chat-input",attr:{placeholder:"\u8F93\u5165\u95EE\u9898\uFF0C\u4E0E\u6587\u6863\u5BF9\u8BDD...",rows:"3"}}),this.inputEl.addEventListener("keydown",f=>{f.key==="Enter"&&!f.shiftKey&&(f.preventDefault(),this.sendCurrentMessage())});let u=c.createDiv({cls:"ai-chat-input-actions"}),d=u.createEl("button",{cls:"ai-chat-icon-btn",attr:{"aria-label":"\u5237\u65B0\u6587\u6863\u4E0A\u4E0B\u6587"}});(0,l.setIcon)(d,"refresh-cw"),d.addEventListener("click",()=>this.refreshDocContext()),this.sendBtn=u.createEl("button",{cls:"ai-chat-send-btn"}),(0,l.setIcon)(this.sendBtn,"send"),this.sendBtn.addEventListener("click",()=>this.sendCurrentMessage()),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>this.updateDocInfo()))}async onClose(){this.abortController&&this.abortController.abort()}renderWelcome(){this.messagesContainer.empty();let t=this.messagesContainer.createDiv({cls:"ai-chat-welcome"});t.createEl("div",{cls:"ai-chat-welcome-icon",text:"\u{1F916}"}),t.createEl("div",{cls:"ai-chat-welcome-title",text:"\u4F60\u597D\uFF01\u6211\u662F\u4F60\u7684 AI \u6587\u6863\u52A9\u624B"}),t.createEl("div",{cls:"ai-chat-welcome-desc",text:"\u6211\u53EF\u4EE5\u5E2E\u4F60\u7406\u89E3\u3001\u603B\u7ED3\u3001\u5206\u6790\u5F53\u524D\u6253\u5F00\u7684\u6587\u6863\u3002\u9009\u62E9\u4E0B\u65B9\u7684\u5FEB\u6377\u64CD\u4F5C\u6216\u76F4\u63A5\u8F93\u5165\u95EE\u9898\u5F00\u59CB\u5BF9\u8BDD\u3002"})}updateDocInfo(){let t=this.app.workspace.getActiveViewOfType(l.MarkdownView);if(t!=null&&t.file){this.currentDocName=t.file.basename,this.docInfoEl.empty();let a=this.docInfoEl.createSpan({cls:"ai-chat-doc-icon"});(0,l.setIcon)(a,"file-text"),this.docInfoEl.createSpan({text:this.currentDocName,cls:"ai-chat-doc-name"})}else this.currentDocName=null,this.docInfoEl.empty(),this.docInfoEl.createSpan({text:"\u672A\u6253\u5F00\u6587\u6863",cls:"ai-chat-doc-none"})}async refreshDocContext(){await this.loadCurrentDoc(),this.currentDocContent&&new l.Notice(`\u5DF2\u5237\u65B0\u6587\u6863\u4E0A\u4E0B\u6587: ${this.currentDocName}`)}async loadCurrentDoc(){let t=this.app.workspace.getActiveViewOfType(l.MarkdownView);return t!=null&&t.file?(this.currentDocName=t.file.basename,this.currentDocContent=await this.app.vault.cachedRead(t.file),!0):(this.currentDocContent=null,this.currentDocName=null,new l.Notice("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A Markdown \u6587\u6863"),!1)}async sendCurrentMessage(){let t=this.inputEl.value.trim();if(!t||this.isLoading)return;let{baseUrl:a,apiKey:n,modelName:s}=this.plugin.settings;if(!a||!n||!s){new l.Notice("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E API");return}!this.currentDocContent&&!await this.loadCurrentDoc()||(this.inputEl.value="",this.messages.push({role:"user",content:t}),this.appendMessage("user",t),await this.getAIResponse(t))}appendMessage(t,a){let n=this.messagesContainer.querySelector(".ai-chat-welcome");n&&n.remove();let s=this.messagesContainer.createDiv({cls:`ai-chat-msg ai-chat-msg-${t}`}),i=s.createDiv({cls:"ai-chat-msg-avatar"});(0,l.setIcon)(i,t==="user"?"user":"bot");let r=s.createDiv({cls:"ai-chat-msg-bubble"});return t==="assistant"?l.MarkdownRenderer.render(this.app,a||"...",r,"",this):r.createEl("p",{text:a}),this.scrollToBottom(),s}scrollToBottom(){requestAnimationFrame(()=>{this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight})}async getAIResponse(t){this.isLoading=!0,this.sendBtn.disabled=!0,this.sendBtn.addClass("ai-chat-loading");let n=this.appendMessage("assistant","").querySelector(".ai-chat-msg-bubble");n.empty(),n.createDiv({cls:"ai-chat-typing",text:"\u601D\u8003\u4E2D..."});try{let s=await this.callChatAPI(t);this.messages.push({role:"assistant",content:s}),n.empty(),await l.MarkdownRenderer.render(this.app,s,n,"",this),this.scrollToBottom()}catch(s){if(s.name==="AbortError")return;let i=s instanceof Error?s.message:String(s);n.empty(),n.createDiv({cls:"ai-chat-error",text:`\u9519\u8BEF: ${i}`})}finally{this.isLoading=!1,this.sendBtn.disabled=!1,this.sendBtn.removeClass("ai-chat-loading")}}async callChatAPI(t){var d,f,T,k;let{baseUrl:a,apiKey:n,modelName:s}=this.plugin.settings,i=this.currentDocContent?`\u4EE5\u4E0B\u662F\u5F53\u524D\u6587\u6863\u300A${this.currentDocName}\u300B\u7684\u5185\u5BB9\uFF1A

---
${this.currentDocContent}
---

`:"",r=[{role:"system",content:j},{role:"user",content:i+"\u8BF7\u8BB0\u4F4F\u4E0A\u9762\u7684\u6587\u6863\u5185\u5BB9\uFF0C\u63A5\u4E0B\u6765\u6211\u4F1A\u5BF9\u4F60\u63D0\u95EE\u3002"},{role:"assistant",content:"\u597D\u7684\uFF0C\u6211\u5DF2\u7ECF\u9605\u8BFB\u4E86\u6587\u6863\u5185\u5BB9\u3002\u8BF7\u95EE\u6709\u4EC0\u4E48\u95EE\u9898\uFF1F"}];for(let g=0;g<this.messages.length-1;g++)r.push({role:this.messages[g].role,content:this.messages[g].content});r.push({role:"user",content:t});let h=a.replace(/\/+$/,"")+"/chat/completions";this.abortController=new AbortController;let u=this.messagesContainer.lastElementChild.querySelector(".ai-chat-msg-bubble");try{let g=await fetch(h,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({model:s,messages:r,temperature:.7,stream:!0}),signal:this.abortController.signal});if(!g.ok){let A=await g.text();throw new Error(`API \u8BF7\u6C42\u5931\u8D25 (${g.status}): ${A}`)}let x=(d=g.body)==null?void 0:d.getReader();if(!x)throw new Error("\u65E0\u6CD5\u83B7\u53D6\u54CD\u5E94\u6D41");let O=new TextDecoder,E="",I="";for(;;){let{done:A,value:B}=await x.read();if(A)break;I+=O.decode(B,{stream:!0});let P=I.split(`
`);I=P.pop()||"";for(let V of P){let S=V.trim();if(!S||!S.startsWith("data:"))continue;let L=S.slice(5).trim();if(L!=="[DONE]")try{let M=(k=(T=(f=JSON.parse(L).choices)==null?void 0:f[0])==null?void 0:T.delta)==null?void 0:k.content;M&&(E+=M,u.empty(),await l.MarkdownRenderer.render(this.app,E,u,"",this),this.scrollToBottom())}catch(F){}}}return this.abortController=null,E||"\uFF08\u65E0\u54CD\u5E94\u5185\u5BB9\uFF09"}catch(g){throw this.abortController=null,g}}clearChat(){this.messages=[],this.currentDocContent=null,this.renderWelcome(),this.updateDocInfo()}};var b=class extends o.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new C(this.app,this)),this.registerView(w,e=>new y(e,this)),this.addRibbonIcon("message-square","\u6253\u5F00 AI \u52A9\u624B",()=>{this.activateChatView()}),this.addCommand({id:"open-ai-chat",name:"\u6253\u5F00 AI \u6587\u6863\u52A9\u624B",callback:()=>this.activateChatView()}),this.addCommand({id:"translate-current-document",name:"\u7FFB\u8BD1\u5F53\u524D\u6587\u6863",callback:()=>this.translateCurrentDocument()}),this.addCommand({id:"translate-selection",name:"\u7FFB\u8BD1\u9009\u4E2D\u6587\u672C",editorCallback:(e,t)=>{this.translateSelection(e)}}),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{t instanceof o.TFile&&t.extension==="md"&&e.addItem(a=>{a.setTitle("AI \u7FFB\u8BD1\u6B64\u6587\u6863").setIcon("languages").onClick(()=>this.translateFile(t))})})),this.registerEvent(this.app.workspace.on("editor-menu",(e,t,a)=>{t.getSelection()&&e.addItem(n=>{n.setTitle("AI \u7FFB\u8BD1\u9009\u4E2D\u6587\u672C").setIcon("languages").onClick(()=>this.translateSelection(t))}),e.addItem(n=>{n.setTitle("AI \u7FFB\u8BD1\u5168\u6587").setIcon("languages").onClick(()=>this.translateCurrentDocument())})}))}async loadSettings(){this.settings=Object.assign({},N,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}validateSettings(){return this.settings.baseUrl?this.settings.apiKey?this.settings.modelName?!0:(new o.Notice("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E\u6A21\u578B\u540D\u79F0"),!1):(new o.Notice("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E API Key"),!1):(new o.Notice("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E API Base URL"),!1)}createTranslator(){let e={baseUrl:this.settings.baseUrl,apiKey:this.settings.apiKey,modelName:this.settings.modelName,targetLang:this.settings.targetLang,systemPrompt:this.settings.systemPrompt,maxChunkSize:this.settings.maxChunkSize};return new v(e)}getTranslatedFilePath(e){let t=e.substring(0,e.lastIndexOf("/")),n=e.substring(e.lastIndexOf("/")+1).replace(/\.md$/,""),s=this.settings.targetLang==="\u7B80\u4F53\u4E2D\u6587"?"zh":this.settings.targetLang,i=`${n}.${s}.md`;return t?`${t}/${i}`:i}async translateCurrentDocument(){if(!this.validateSettings())return;let e=this.app.workspace.getActiveViewOfType(o.MarkdownView);if(!e||!e.file){new o.Notice("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A Markdown \u6587\u6863");return}await this.translateFile(e.file)}async translateFile(e){if(!this.validateSettings())return;let t=this.createTranslator(),a=await this.app.vault.cachedRead(e);if(!a.trim()){new o.Notice("\u6587\u6863\u5185\u5BB9\u4E3A\u7A7A\uFF0C\u65E0\u9700\u7FFB\u8BD1");return}let n=this.settings.translationMode,s=new o.Notice(`\u6B63\u5728\u7FFB\u8BD1: ${e.basename}...`,0);try{let i=await t.translateDocument(a,(r,h)=>{s.setMessage(`\u6B63\u5728\u7FFB\u8BD1: ${e.basename} (${r}/${h} \u6BB5)`)});if(n==="replace")await this.app.vault.modify(e,i),s.hide(),new o.Notice("\u7FFB\u8BD1\u5B8C\u6210\uFF01\u5DF2\u66FF\u6362\u539F\u6587");else if(n==="append"){let r=`

---

`,h=this.settings.targetLang,c=`${a}${r}## \u7FFB\u8BD1 (${h})

${i}`;await this.app.vault.modify(e,c),s.hide(),new o.Notice("\u7FFB\u8BD1\u5B8C\u6210\uFF01\u5DF2\u8FFD\u52A0\u5230\u539F\u6587\u4E0B\u65B9")}else{let r=this.getTranslatedFilePath(e.path),h=this.app.vault.getAbstractFileByPath(r);h instanceof o.TFile?await this.app.vault.modify(h,i):await this.app.vault.create(r,i),s.hide(),new o.Notice(`\u7FFB\u8BD1\u5B8C\u6210! \u5DF2\u4FDD\u5B58\u5230: ${r}`);let c=this.app.vault.getAbstractFileByPath(r);c instanceof o.TFile&&await this.app.workspace.getLeaf(!1).openFile(c)}}catch(i){s.hide();let r=i instanceof Error?i.message:String(i);new o.Notice(`\u7FFB\u8BD1\u5931\u8D25: ${r}`,8e3),console.error("AI Translator error:",i)}}async activateChatView(){let e=this.app.workspace.getLeavesOfType(w);if(e.length){this.app.workspace.revealLeaf(e[0]);return}let t=this.app.workspace.getRightLeaf(!1);t&&(await t.setViewState({type:w,active:!0}),this.app.workspace.revealLeaf(t))}async translateSelection(e){if(!this.validateSettings())return;let t=e.getSelection();if(!t.trim()){new o.Notice("\u8BF7\u5148\u9009\u4E2D\u8981\u7FFB\u8BD1\u7684\u6587\u672C");return}let a=this.createTranslator(),n=new o.Notice("\u6B63\u5728\u7FFB\u8BD1\u9009\u4E2D\u6587\u672C...",0);try{let s=await a.translateDocument(t,(i,r)=>{n.setMessage(`\u6B63\u5728\u7FFB\u8BD1\u9009\u4E2D\u6587\u672C (${i}/${r} \u6BB5)`)});e.replaceSelection(s),n.hide(),new o.Notice("\u9009\u4E2D\u6587\u672C\u7FFB\u8BD1\u5B8C\u6210!")}catch(s){n.hide();let i=s instanceof Error?s.message:String(s);new o.Notice(`\u7FFB\u8BD1\u5931\u8D25: ${i}`,8e3),console.error("AI Translator error:",s)}}};
